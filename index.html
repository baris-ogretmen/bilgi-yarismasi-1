import React, { useState, useEffect, useRef } from 'react';
import { Trophy, Users, BookOpen, Brain, Swords, Star, Settings, RefreshCw, Check, X, Sparkles, Play, Flame, BarChart2, Medal, Zap, LayoutGrid } from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, query, orderBy, limit, increment } from 'firebase/firestore';

// --- SES EFEKTLERİ (Harici dosya gerektirmez) ---
const playSound = (type) => {
  const AudioContext = window.AudioContext || window.webkitAudioContext;
  if (!AudioContext) return;
  const ctx = new AudioContext();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.connect(gain);
  gain.connect(ctx.destination);

  const now = ctx.currentTime;
  
  if (type === 'correct') {
    osc.type = 'sine';
    osc.frequency.setValueAtTime(500, now);
    osc.frequency.exponentialRampToValueAtTime(1000, now + 0.1);
    gain.gain.setValueAtTime(0.3, now);
    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
    osc.start(now);
    osc.stop(now + 0.5);
  } else if (type === 'wrong') {
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(200, now);
    osc.frequency.exponentialRampToValueAtTime(50, now + 0.3);
    gain.gain.setValueAtTime(0.3, now);
    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
    osc.start(now);
    osc.stop(now + 0.5);
  } else if (type === 'joker') {
    osc.type = 'triangle';
    osc.frequency.setValueAtTime(600, now);
    osc.frequency.linearRampToValueAtTime(800, now + 0.1);
    gain.gain.setValueAtTime(0.2, now);
    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
    osc.start(now);
    osc.stop(now + 0.5);
  }
};

// --- YEREL SORU BANKASI ---
const generateLocalQuestion = (grade) => {
  const subjects = ['Matematik', 'Türkçe', 'Fen Bilimleri', 'Sosyal/Hayat'];
  const subject = subjects[Math.floor(Math.random() * subjects.length)];
  let q = { text: '', options: [], correct: 0, subject };

  if (subject === 'Matematik') {
    const operation = Math.random();
    let a, b, ans;
    if (grade <= 2) {
      a = Math.floor(Math.random() * 20) + 1;
      b = Math.floor(Math.random() * 20) + 1;
      if (operation > 0.5) { q.text = `${a} + ${b} = ?`; ans = a + b; }
      else { q.text = `${Math.max(a, b)} - ${Math.min(a, b)} = ?`; ans = Math.max(a, b) - Math.min(a, b); }
    } else {
      a = Math.floor(Math.random() * 10) + 2;
      b = Math.floor(Math.random() * 10) + 2;
      if (operation > 0.5) { q.text = `${a} x ${b} = ?`; ans = a * b; }
      else { let res = a * b; q.text = `${res} ÷ ${a} = ?`; ans = b; }
    }
    let options = [ans];
    while (options.length < 4) {
      let fake = ans + Math.floor(Math.random() * 10) - 5;
      if (fake !== ans && fake >= 0 && !options.includes(fake)) options.push(fake);
    }
    q.options = options.sort(() => Math.random() - 0.5);
    q.correct = q.options.indexOf(ans);
  } else {
    const templates = [
      { t: "İstiklal Marşı'mızın şairi kimdir?", o: ["Mehmet Akif Ersoy", "Ömer Seyfettin", "Ziya Gökalp", "Namık Kemal"], c: 0, s: "Türkçe" },
      { t: "Hangisi bir duyu organımız değildir?", o: ["Kalp", "Göz", "Kulak", "Deri"], c: 0, s: "Fen Bilimleri" },
      { t: "Türkiye'nin başkenti neresidir?", o: ["Ankara", "İstanbul", "İzmir", "Konya"], c: 0, s: "Sosyal/Hayat" },
      { t: "Bir deste kaç tanedir?", o: ["10", "12", "20", "5"], c: 0, s: "Matematik" },
      { t: "Hangisi yaz mevsimi ayıdır?", o: ["Temmuz", "Ocak", "Mart", "Ekim"], c: 0, s: "Sosyal/Hayat" },
    ];
    const selected = templates[Math.floor(Math.random() * templates.length)];
    q.text = selected.t;
    q.options = selected.o;
    q.correct = selected.c;
    q.subject = selected.s;
  }
  return q;
};

// --- GEMINI API ---
const fetchGeminiQuestion = async (apiKey, grade) => {
  if (!apiKey) return null;
  const prompt = `Sen bir ilkokul/ortaokul öğretmenisin. ${grade}. Sınıf seviyesine uygun, Matematik, Türkçe, Fen veya Sosyal derslerinden rastgele birinden ÇOKTAN SEÇMELİ tek bir soru hazırla. JSON formatı: {"text": "soru", "options": ["A", "B", "C", "D"], "correctIndex": 0, "subject": "ders"}`;
  try {
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
    });
    const data = await response.json();
    const rawText = data.candidates[0].content.parts[0].text;
    const jsonString = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
    const parsed = JSON.parse(jsonString);
    return { text: parsed.text, options: parsed.options, correct: parsed.correctIndex, subject: parsed.subject };
  } catch (e) { return null; }
};

export default function OkulLigiPro() {
  // --- FIREBASE INIT ---
  const [user, setUser] = useState(null);
  const [db, setDb] = useState(null);
  const [appId, setAppId] = useState('school-league-v1'); // Sabit veya dinamik ID
  
  useEffect(() => {
    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const firestore = getFirestore(app);
    setDb(firestore);
    setAppId(typeof __app_id !== 'undefined' ? __app_id : 'school-league-v1');

    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    return onAuthStateChanged(auth, setUser);
  }, []);

  // --- STATE ---
  const [phase, setPhase] = useState('setup'); // setup, bracket, battle, leaderboard
  const [grade, setGrade] = useState(5);
  const [apiKey, setApiKey] = useState('');
  const [rawNames, setRawNames] = useState('');
  const [matches, setMatches] = useState([]);
  const [currentMatchIndex, setCurrentMatchIndex] = useState(0);
  const [leaderboardData, setLeaderboardData] = useState([]);

  // Battle State
  const [p1Score, setP1Score] = useState(0);
  const [p2Score, setP2Score] = useState(0);
  const [p1Streak, setP1Streak] = useState(0);
  const [p2Streak, setP2Streak] = useState(0);
  const [p1JokerUsed, setP1JokerUsed] = useState(false);
  const [p2JokerUsed, setP2JokerUsed] = useState(false);
  
  const [currentQuestion, setCurrentQuestion] = useState(null);
  const [loadingQ, setLoadingQ] = useState(false);
  const [answerState, setAnswerState] = useState('waiting');
  const [timer, setTimer] = useState(20);
  const [hiddenOptions, setHiddenOptions] = useState([]); // Joker ile gizlenen şıklar

  // --- FIREBASE LEADERBOARD LISTENER ---
  useEffect(() => {
    if (!user || !db) return;
    // Okul geneli verileri çek (artifacts/public/data/scores)
    const q = collection(db, 'artifacts', appId, 'public', 'data', 'scores');
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const data = [];
      snapshot.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
      setLeaderboardData(data);
    }, (error) => console.error("Data fetch error:", error));

    return () => unsubscribe();
  }, [user, db, appId]);

  // --- SAVE SCORE TO FIREBASE ---
  const saveWinnerToCloud = async (winnerName, score) => {
    if (!user || !db) return;
    // Öğrenci ID'sini isim ve sınıftan oluştur (basit unique key)
    const studentId = `${winnerName}-${grade}`.replace(/\s+/g, '-').toLowerCase();
    
    try {
      const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'scores', studentId);
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        await updateDoc(docRef, {
          score: increment(score),
          wins: increment(1),
          lastPlayed: new Date().toISOString()
        });
      } else {
        await setDoc(docRef, {
          name: winnerName,
          grade: grade,
          score: score,
          wins: 1,
          lastPlayed: new Date().toISOString()
        });
      }
    } catch (e) {
      console.error("Save error:", e);
    }
  };

  // --- GAME LOGIC ---
  const handleCreateMatches = () => {
    const names = rawNames.split('\n').map(n => n.trim()).filter(n => n.length > 0);
    if (names.length < 2) return alert("En az 2 öğrenci gerekli.");
    
    const shuffled = [...names].sort(() => Math.random() - 0.5);
    const newMatches = [];
    for (let i = 0; i < shuffled.length; i += 2) {
      if (i + 1 < shuffled.length) newMatches.push({ p1: shuffled[i], p2: shuffled[i+1], winner: null });
      else newMatches.push({ p1: shuffled[i], p2: "BAY (Otomatik)", winner: shuffled[i] });
    }
    setMatches(newMatches);
    setPhase('bracket');
  };

  const startMatch = (index) => {
    if (matches[index].p2.includes("BAY")) return;
    setCurrentMatchIndex(index);
    setP1Score(0); setP2Score(0);
    setP1Streak(0); setP2Streak(0);
    setP1JokerUsed(false); setP2JokerUsed(false);
    setPhase('battle');
    loadNewQuestion();
  };

  const loadNewQuestion = async () => {
    setLoadingQ(true);
    setAnswerState('waiting');
    setHiddenOptions([]);
    setTimer(20);

    let q = apiKey ? await fetchGeminiQuestion(apiKey, grade) : null;
    if (!q) q = generateLocalQuestion(grade);
    
    setCurrentQuestion(q);
    setLoadingQ(false);
  };

  useEffect(() => {
    let interval;
    if (phase === 'battle' && answerState === 'waiting' && timer > 0) interval = setInterval(() => setTimer(t => t - 1), 1000);
    else if (timer === 0 && answerState === 'waiting') { setAnswerState('timeout'); playSound('wrong'); setTimeout(loadNewQuestion, 2000); }
    return () => clearInterval(interval);
  }, [timer, phase, answerState]);

  const useJoker = (player) => {
    if ((player === 'p1' && p1JokerUsed) || (player === 'p2' && p2JokerUsed)) return;
    if (answerState !== 'waiting' || !currentQuestion) return;

    // Yanlış şıkları bul
    const wrongIndices = currentQuestion.options
      .map((_, idx) => idx)
      .filter(idx => idx !== currentQuestion.correct);
    
    // Rastgele 2 tanesini seç (eğer 3 yanlış varsa)
    const toHide = wrongIndices.sort(() => Math.random() - 0.5).slice(0, 2);
    
    setHiddenOptions(toHide);
    playSound('joker');
    if (player === 'p1') setP1JokerUsed(true);
    else setP2JokerUsed(true);
  };

  const handleAnswer = (optionIndex, player) => {
    if (answerState !== 'waiting') return;

    const isCorrect = optionIndex === currentQuestion.correct;
    
    if (isCorrect) {
      setAnswerState('correct');
      playSound('correct');
      // Puan Hesaplama (Streak Çarpanı)
      const multiplier = player === 'p1' ? (p1Streak >= 2 ? 2 : 1) : (p2Streak >= 2 ? 2 : 1);
      const points = 10 * multiplier;

      if (player === 'p1') {
        setP1Score(s => s + points);
        setP1Streak(s => s + 1);
        setP2Streak(0); // Rakibin serisi bozulur mu? Hayır, sıra tabanlı değil aynı anda soruluyor gibi. Ama burada "kim cevap verdi" mantığı var. Rakibin serisini bozmayalım.
      } else {
        setP2Score(s => s + points);
        setP2Streak(s => s + 1);
        setP1Streak(0);
      }
    } else {
      setAnswerState('wrong');
      playSound('wrong');
      if (player === 'p1') setP1Streak(0);
      else setP2Streak(0);
    }

    setTimeout(() => {
      const currentP1 = player === 'p1' && isCorrect ? p1Score + (10 * (p1Streak >= 2 ? 2 : 1)) : p1Score;
      const currentP2 = player === 'p2' && isCorrect ? p2Score + (10 * (p2Streak >= 2 ? 2 : 1)) : p2Score;
      
      if (currentP1 >= 60 || currentP2 >= 60) {
        const winner = currentP1 > currentP2 ? matches[currentMatchIndex].p1 : matches[currentMatchIndex].p2;
        const wScore = Math.max(currentP1, currentP2);
        saveWinnerToCloud(winner, wScore); // Firebase Kayıt
        finishMatch(winner);
      } else {
        loadNewQuestion();
      }
    }, 2000);
  };

  const finishMatch = (winnerName) => {
    const updatedMatches = [...matches];
    updatedMatches[currentMatchIndex].winner = winnerName;
    setMatches(updatedMatches);
    setPhase('bracket');
  };

  // --- RENDER VIEWS ---
  const renderSetup = () => (
    <div className="max-w-3xl mx-auto bg-white p-8 rounded-3xl shadow-2xl">
      <div className="text-center mb-10">
        <h1 className="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 mb-4 flex items-center justify-center gap-4">
          <Brain className="w-12 h-12 text-blue-600" /> Okul Ligi Pro
        </h1>
        <p className="text-gray-500 text-lg">Bulut Tabanlı Bilgi Yarışması Turnuvası</p>
      </div>

      <div className="grid md:grid-cols-2 gap-8">
        <div className="space-y-6">
          <div>
            <label className="block text-sm font-bold text-gray-700 mb-2">Sınıf Seviyesi</label>
            <select value={grade} onChange={(e) => setGrade(Number(e.target.value))} className="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
              {[1,2,3,4,5,6,7,8].map(g => <option key={g} value={g}>{g}. Sınıf</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold text-gray-700 mb-2 flex items-center gap-2">
              <Sparkles className="w-4 h-4 text-purple-500" /> Gemini API (Opsiyonel)
            </label>
            <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="AI-..." className="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-purple-500" />
          </div>
          <button onClick={() => setPhase('leaderboard')} className="w-full py-4 bg-orange-100 text-orange-700 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-orange-200 transition-colors">
            <Trophy className="w-5 h-5" /> SIRALAMALARI GÖR
          </button>
        </div>

        <div className="space-y-4">
           <label className="block text-sm font-bold text-gray-700">Öğrenci Listesi</label>
           <textarea 
             rows={8} 
             className="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none resize-none"
             placeholder="Ali Yılmaz&#10;Ayşe Can&#10;..."
             value={rawNames}
             onChange={(e) => setRawNames(e.target.value)}
           />
           <button onClick={handleCreateMatches} className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-4 rounded-xl font-bold text-lg hover:shadow-lg transform hover:-translate-y-1 transition-all flex items-center justify-center gap-2">
             <Swords className="w-6 h-6" /> TURNUVAYI BAŞLAT
           </button>
        </div>
      </div>
      <div className="mt-6 flex items-center gap-2 text-xs text-green-600 justify-center font-medium bg-green-50 p-2 rounded-lg">
        <Sparkles className="w-3 h-3" /> Firebase Bağlantısı Aktif: Veriler Otomatik Kaydedilir
      </div>
    </div>
  );

  const renderLeaderboard = () => {
    // Sıralama Mantığı
    const schoolRank = [...leaderboardData].sort((a, b) => b.score - a.score).slice(0, 10);
    const classRank = [...leaderboardData].filter(d => d.grade === grade).sort((a, b) => b.score - a.score);

    return (
      <div className="max-w-5xl mx-auto">
        <div className="flex justify-between items-center mb-8">
          <h2 className="text-3xl font-bold text-gray-800 flex items-center gap-3">
            <Trophy className="text-yellow-500 w-8 h-8" /> Liderlik Tablosu
          </h2>
          <button onClick={() => setPhase('setup')} className="bg-gray-200 px-6 py-2 rounded-full font-bold hover:bg-gray-300 transition">Geri Dön</button>
        </div>

        <div className="grid md:grid-cols-2 gap-8">
          {/* Okul Geneli */}
          <div className="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-yellow-400">
            <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-yellow-600"><Star className="fill-yellow-500" /> Okul Geneli Top 10</h3>
            <div className="space-y-3">
              {schoolRank.map((s, i) => (
                <div key={i} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                  <div className="flex items-center gap-3">
                    <span className={`w-8 h-8 flex items-center justify-center rounded-full font-bold ${i < 3 ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-200 text-gray-600'}`}>{i+1}</span>
                    <div>
                      <div className="font-bold">{s.name}</div>
                      <div className="text-xs text-gray-500">{s.grade}. Sınıf</div>
                    </div>
                  </div>
                  <div className="text-right">
                    <div className="font-bold text-blue-600">{s.score} P</div>
                    <div className="text-xs text-gray-400">{s.wins} Galibiyet</div>
                  </div>
                </div>
              ))}
              {schoolRank.length === 0 && <p className="text-center text-gray-400 py-4">Henüz veri yok.</p>}
            </div>
          </div>

          {/* Sınıf Geneli */}
          <div className="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-blue-400">
            <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-blue-600"><Users /> {grade}. Sınıf Sıralaması</h3>
            <div className="space-y-3">
              {classRank.map((s, i) => (
                <div key={i} className="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                  <div className="flex items-center gap-3">
                    <span className="font-bold text-blue-800 w-6">{i+1}.</span>
                    <div className="font-bold">{s.name}</div>
                  </div>
                  <div className="font-bold text-blue-600">{s.score} P</div>
                </div>
              ))}
              {classRank.length === 0 && <p className="text-center text-gray-400 py-4">Bu sınıfta henüz yarışma yapılmadı.</p>}
            </div>
          </div>
        </div>
      </div>
    );
  };

  const renderBattle = () => {
    const m = matches[currentMatchIndex];
    if (!m) return null;

    return (
      <div className="h-screen flex flex-col bg-slate-900 text-white overflow-hidden">
        {/* Top Bar */}
        <div className="h-24 bg-slate-800 flex items-center justify-between px-8 border-b border-slate-700 shadow-lg z-10">
          <div className="flex items-center gap-4 w-1/3">
            <div className={`flex flex-col items-start ${p1Streak >= 2 ? 'animate-pulse' : ''}`}>
              <h3 className="text-2xl font-bold text-blue-400 flex items-center gap-2">
                {m.p1} 
                {p1Streak >= 2 && <Flame className="text-orange-500 fill-orange-500 animate-bounce" />}
              </h3>
              <div className="flex items-center gap-2">
                <span className="text-4xl font-mono">{p1Score}</span>
                {p1Streak >= 2 && <span className="text-xs bg-orange-500 text-black px-2 py-1 rounded-full font-bold">x2 COMBO</span>}
              </div>
            </div>
            {/* Joker P1 */}
            <button 
              onClick={() => useJoker('p1')}
              disabled={p1JokerUsed} 
              className={`p-2 rounded-lg border-2 ${p1JokerUsed ? 'border-gray-600 text-gray-600 opacity-30' : 'border-blue-500 text-blue-400 hover:bg-blue-900'}`}
              title="50/50 Jokeri"
            >
              <Zap className="w-6 h-6" />
            </button>
          </div>
          
          <div className="flex flex-col items-center">
            <div className={`text-5xl font-black ${timer < 5 ? 'text-red-500 scale-110' : 'text-yellow-400'} transition-all`}>
              {timer}
            </div>
          </div>

          <div className="flex items-center gap-4 w-1/3 justify-end">
            {/* Joker P2 */}
            <button 
              onClick={() => useJoker('p2')}
              disabled={p2JokerUsed} 
              className={`p-2 rounded-lg border-2 ${p2JokerUsed ? 'border-gray-600 text-gray-600 opacity-30' : 'border-red-500 text-red-400 hover:bg-red-900'}`}
              title="50/50 Jokeri"
            >
              <Zap className="w-6 h-6" />
            </button>
            <div className={`flex flex-col items-end ${p2Streak >= 2 ? 'animate-pulse' : ''}`}>
              <h3 className="text-2xl font-bold text-red-400 flex items-center gap-2">
                {p2Streak >= 2 && <Flame className="text-orange-500 fill-orange-500 animate-bounce" />}
                {m.p2}
              </h3>
              <div className="flex items-center gap-2">
                 {p2Streak >= 2 && <span className="text-xs bg-orange-500 text-black px-2 py-1 rounded-full font-bold">x2 COMBO</span>}
                <span className="text-4xl font-mono">{p2Score}</span>
              </div>
            </div>
          </div>
        </div>

        {/* Question Area */}
        <div className="flex-1 flex items-center justify-center p-6 relative">
          {loadingQ ? (
            <div className="animate-spin"><RefreshCw className="w-20 h-20 text-blue-500 opacity-50" /></div>
          ) : currentQuestion ? (
            <div className="w-full max-w-5xl">
              <div className="bg-white/10 backdrop-blur-md border border-white/20 p-8 rounded-3xl shadow-2xl mb-8 text-center relative">
                <span className="absolute top-4 right-4 bg-purple-600 text-white px-4 py-1 rounded-full text-sm font-bold tracking-wider uppercase shadow-lg">
                  {currentQuestion.subject}
                </span>
                <h2 className="text-3xl md:text-5xl font-bold mt-4 leading-snug drop-shadow-lg">
                  {currentQuestion.text}
                </h2>
              </div>

              <div className="grid grid-cols-2 gap-6">
                {currentQuestion.options.map((opt, idx) => {
                  let btnClass = "bg-slate-800 hover:bg-slate-700 border-2 border-slate-600";
                  if (answerState !== 'waiting') {
                    if (idx === currentQuestion.correct) btnClass = "bg-green-600 border-green-400 scale-105 shadow-[0_0_30px_rgba(34,197,94,0.5)]";
                    else btnClass = "bg-slate-800 opacity-30 grayscale";
                  }
                  
                  // Joker ile gizlenen şıklar
                  if (hiddenOptions.includes(idx)) return <div key={idx} className="bg-transparent"></div>;

                  return (
                    <div key={idx} className={`p-6 rounded-2xl text-2xl font-bold transition-all transform duration-300 text-center flex items-center justify-center min-h-[100px] text-white shadow-xl ${btnClass}`}>
                      {opt}
                    </div>
                  );
                })}
              </div>
              
              {/* Teacher Controls */}
              <div className="mt-12 flex justify-between items-center opacity-80 hover:opacity-100 transition-opacity">
                <div className="bg-blue-900/50 p-4 rounded-xl border border-blue-500/30">
                  <p className="text-blue-300 text-xs mb-2 font-bold uppercase tracking-widest text-center">Öğretmen Paneli: {m.p1}</p>
                  <div className="flex gap-2">
                    {["A", "B", "C", "D"].map((l, i) => (
                      <button key={i} disabled={answerState !== 'waiting' || hiddenOptions.includes(i)} onClick={() => handleAnswer(i, 'p1')} className="w-12 h-12 bg-blue-600 hover:bg-blue-500 rounded-lg font-bold text-xl shadow-lg disabled:opacity-20 disabled:cursor-not-allowed">{l}</button>
                    ))}
                  </div>
                </div>

                <div className="text-center">
                   {answerState === 'correct' && <div className="text-green-400 text-4xl font-black animate-bounce drop-shadow-[0_0_10px_rgba(74,222,128,0.8)]">HARİKA!</div>}
                   {answerState === 'wrong' && <div className="text-red-500 text-4xl font-black animate-shake">YANLIŞ!</div>}
                   {answerState === 'timeout' && <div className="text-yellow-500 text-4xl font-black">ZAMAN DOLDU</div>}
                </div>

                <div className="bg-red-900/50 p-4 rounded-xl border border-red-500/30">
                  <p className="text-red-300 text-xs mb-2 font-bold uppercase tracking-widest text-center">Öğretmen Paneli: {m.p2}</p>
                  <div className="flex gap-2">
                    {["A", "B", "C", "D"].map((l, i) => (
                      <button key={i} disabled={answerState !== 'waiting' || hiddenOptions.includes(i)} onClick={() => handleAnswer(i, 'p2')} className="w-12 h-12 bg-red-600 hover:bg-red-500 rounded-lg font-bold text-xl shadow-lg disabled:opacity-20 disabled:cursor-not-allowed">{l}</button>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          ) : null}
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans">
      {phase === 'bracket' && (
        <div className="max-w-6xl mx-auto p-6">
           <div className="flex justify-between items-center mb-8">
            <h2 className="text-3xl font-bold text-gray-800">Fikstür</h2>
            <div className="flex gap-4">
              <button onClick={() => setPhase('leaderboard')} className="flex items-center gap-2 text-blue-600 font-bold bg-blue-100 px-4 py-2 rounded-lg hover:bg-blue-200"><Trophy size={18}/> Sıralama</button>
              <button onClick={() => setPhase('setup')} className="text-gray-500 hover:text-red-500 font-medium">Yeni Yarışma</button>
            </div>
          </div>
          <div className="grid md:grid-cols-2 gap-6">
            {matches.map((m, idx) => (
              <div key={idx} className={`relative bg-white p-6 rounded-2xl shadow-lg border-l-8 ${m.winner ? 'border-green-500 bg-green-50' : 'border-blue-500'} flex items-center justify-between transition-transform hover:scale-[1.01]`}>
                <div className="flex-1 grid grid-cols-[1fr,auto,1fr] items-center gap-4 text-center">
                  <div className={`font-bold text-lg ${m.winner === m.p1 ? 'text-green-700' : 'text-gray-700'}`}>{m.p1} {m.winner === m.p1 && <Trophy className="inline w-4 h-4 text-yellow-500"/>}</div>
                  <div className="bg-gray-200 text-gray-500 text-xs font-bold px-2 py-1 rounded">VS</div>
                  <div className={`font-bold text-lg ${m.winner === m.p2 ? 'text-green-700' : 'text-gray-700'}`}>{m.p2} {m.winner === m.p2 && <Trophy className="inline w-4 h-4 text-yellow-500"/>}</div>
                </div>
                {!m.winner && !m.p2.includes("BAY") && (
                  <button onClick={() => startMatch(idx)} className="ml-4 bg-blue-600 text-white p-4 rounded-full hover:bg-blue-700 shadow-xl hover:scale-110 transition-all group">
                    <Play className="w-6 h-6 ml-1 group-hover:animate-pulse" />
                  </button>
                )}
                {m.winner && <div className="ml-4 text-green-600 font-bold bg-green-200 px-3 py-1 rounded-full text-xs">BİTTİ</div>}
              </div>
            ))}
          </div>
        </div>
      )}

      {phase === 'setup' && <div className="p-6">{renderSetup()}</div>}
      {phase === 'leaderboard' && <div className="p-6">{renderLeaderboard()}</div>}
      {phase === 'battle' && renderBattle()}
    </div>
  );
}
